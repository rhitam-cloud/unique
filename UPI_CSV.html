<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UPI QR Generator</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>

<body class="bg-gray-100 p-4">

<div class="max-w-lg mx-auto space-y-4">

<!-- ================= MY UPI IDS ================= -->
<div class="bg-white p-4 rounded shadow">
<h2 class="text-lg font-bold">My UPI IDs</h2>

<input id="upiName" placeholder="Label (eg: Personal)"
class="w-full p-2 border mt-2">

<input id="upiId" placeholder="upi@bank"
class="w-full p-2 border mt-2">

<button id="addUpi"
class="w-full bg-blue-600 text-white p-2 mt-2 rounded">
Add UPI
</button>

<div class="grid grid-cols-2 gap-2 mt-2">
<button id="exportCSV" class="bg-green-600 text-white p-2 rounded">
Export CSV
</button>

<label class="bg-yellow-500 text-white p-2 rounded text-center cursor-pointer">
Import CSV
<input type="file" id="importCSV" accept=".csv" hidden>
</label>
</div>

<div id="upiList" class="mt-3 space-y-2"></div>
</div>

<!-- ================= QR SECTION ================= -->
<div class="bg-white p-4 rounded shadow">
<h2 class="text-lg font-bold text-center">UPI QR Generator</h2>

<input id="payeeVpa" placeholder="UPI ID"
class="w-full p-2 border mt-2">

<input id="payeeName" placeholder="Payee Name"
class="w-full p-2 border mt-2">

<input id="amount" type="number" min="1"
placeholder="Amount ₹"
class="w-full p-2 border mt-2">

<button id="generateQR"
class="w-full bg-blue-700 text-white p-2 mt-3 rounded">
Generate QR
</button>

<div id="qrBox" class="mt-4 flex justify-center"></div>
</div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
const upiName = document.getElementById("upiName");
const upiId = document.getElementById("upiId");
const upiList = document.getElementById("upiList");

const payeeVpa = document.getElementById("payeeVpa");
const payeeName = document.getElementById("payeeName");
const amount = document.getElementById("amount");
const qrBox = document.getElementById("qrBox");

/* -------- RENDER UPI LIST -------- */
function renderUpi() {
    const data = JSON.parse(localStorage.getItem("upiList")) || [];
    upiList.innerHTML = "";

    if (data.length === 0) {
        upiList.innerHTML =
          "<p class='text-sm text-gray-500'>No UPI IDs saved</p>";
        return;
    }

    data.forEach(u => {
        const div = document.createElement("div");
        div.className =
          "flex justify-between items-center p-2 border rounded";

        div.innerHTML = `
        <div>
            <b>${u.name}</b><br>
            <span class="text-xs text-gray-600">${u.id}</span>
        </div>
        <div class="space-x-2">
            <button class="use text-blue-600 text-sm">Use</button>
            <button class="del text-red-600 text-sm">Delete ❌</button>
        </div>`;

        /* USE BUTTON */
        div.querySelector(".use").onclick = () => {
            payeeVpa.value = u.id;
            payeeName.value = u.name;
        };

        /* DELETE BUTTON */
        div.querySelector(".del").onclick = () => {
            if (confirm(`Delete UPI "${u.id}" ?`)) {
                let arr = JSON.parse(localStorage.getItem("upiList")) || [];
                arr = arr.filter(a => a.id !== u.id);
                localStorage.setItem("upiList", JSON.stringify(arr));
                renderUpi();
            }
        };

        upiList.appendChild(div);
    });
}

/* -------- ADD UPI -------- */
document.getElementById("addUpi").onclick = () => {
    if (!upiName.value || !upiId.value || !upiId.value.includes("@")) {
        alert("Enter valid UPI details");
        return;
    }

    let arr = JSON.parse(localStorage.getItem("upiList")) || [];
    if (arr.some(a => a.id === upiId.value)) {
        alert("UPI already exists");
        return;
    }

    arr.push({ name: upiName.value, id: upiId.value });
    localStorage.setItem("upiList", JSON.stringify(arr));

    upiName.value = "";
    upiId.value = "";
    renderUpi();
};

/* -------- EXPORT CSV -------- */
document.getElementById("exportCSV").onclick = () => {
    let arr = JSON.parse(localStorage.getItem("upiList")) || [];
    if (!arr.length) return alert("No data to export");

    let csv = "name,upi_id\n";
    arr.forEach(a => csv += `${a.name},${a.id}\n`);

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "my_upi_ids.csv";
    a.click();
};

/* -------- IMPORT CSV -------- */
document.getElementById("importCSV").onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        let lines = reader.result.replace(/\r/g,"")
                      .split("\n").slice(1);
        let arr = JSON.parse(localStorage.getItem("upiList")) || [];

        lines.forEach(l => {
            const [n, i] = l.split(",");
            if (n && i && !arr.some(a => a.id === i.trim())) {
                arr.push({ name: n.trim(), id: i.trim() });
            }
        });

        localStorage.setItem("upiList", JSON.stringify(arr));
        renderUpi();
    };
    reader.readAsText(file);
};

/* -------- GENERATE QR -------- */
document.getElementById("generateQR").onclick = () => {
    if (!payeeVpa.value || !payeeName.value || amount.value <= 0) {
        alert("Fill all QR fields");
        return;
    }

    qrBox.innerHTML = "";
    const uri =
      `upi://pay?pa=${payeeVpa.value}&pn=${payeeName.value}&am=${amount.value}&cu=INR`;

    new QRCode(qrBox, { text: uri, width: 230, height: 230 });
};

/* INITIAL LOAD */
renderUpi();
</script>

</body>
</html>
